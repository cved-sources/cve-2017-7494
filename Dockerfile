FROM debian:jessie

LABEL author="opsxcq (opsxcq@strm.sh)"
LABEL maintainer="cved (cved@protonmail.com)"

ENV LANG C.UTF-8
ENV LANGUAGE C.UTF-8
ENV LC_ALL C.UTF-8

ARG DEBIAN_FRONTEND=noninteractive
RUN apt-get -y update \
    && apt-get -y install \
    acl \
    attr \
    autoconf \
    bison \
    build-essential \
    debhelper \
    dnsutils \
    docbook-xml \
    docbook-xsl \
    flex \
    gdb \
    krb5-user \
    libacl1-dev \
    libaio-dev \
    libattr1-dev \
    libblkid-dev \
    libbsd-dev \
    libcap-dev \
    libcups2-dev \
    libgnutls28-dev \
    libjson-perl \
    libldap2-dev \
    libncurses5-dev \
    libpam0g-dev \
    libparse-yapp-perl \
    libpopt-dev \
    libreadline-dev \
    perl \
    perl-modules \
    pkg-config \
    python-all-dev \
    python-dev \
    python-dnspython \
    python-crypto \
    xsltproc \
    zlib1g-dev \
    && apt-get autoremove \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

COPY build/src /src/

RUN cd /src \
    && ./configure \
    && make \
    && make install

COPY build/smb.conf /

RUN addgroup -gid 666 cved \
    && (sleep 1;echo "cved") | adduser --gid 666 --uid 666 cved \
    && (sleep 1;echo "cved") | /usr/local/samba/bin/smbpasswd -a -s -c /smb.conf cved \
    && mkdir /data \
    && chown 666:666 /data

EXPOSE 137/udp 138/udp 139 445

ENTRYPOINT ["/usr/local/samba/sbin/smbd"]

CMD ["-F", "-S", "-s", "/smb.conf", "--debuglevel=10"]
